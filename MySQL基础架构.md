# MySQL基础架构

## 1.整体架构

- 客户端通过 TCP, UNIX 域套接字等方式连接到 MySQL 服务器.

- 客户端进程向服务端进程发送一段文本(SQL 语句), 服务器进程处理后再向客户端进程发送一段文本(处理结果);

- 服务端处理可以分为三部分:
    - 连接管理: MySQL 服务器会为每一个连接进来的客户端分配一个线程;
    - sql 语句解析优化: 包括语法解析(编译), 查询优化(外连接转换为内连接、表达式简化、子查询转为连接);
    - 存储引擎: 对数据的存储和提取操作的封装;

![MySQL](./image/mysql.jpg)

![MySQL](/Users/lfeng/GitHub/DB/image/mysql.png)

## 2.连接器

- MySQL 服务器会为每一个连接进来的客户端分配一个线程, 查询只会在这个单独的线程中执行.
- 连接过程比较耗时, 客户端应尽量使用长连接或连接池. 

- MySQL在执行过程中临时使用的内存是管理在连接对象里, 这些资源会在连接断开或者是执行`mysql_reset_connection`函数时释放.
- 可以通过`show processlist`查询连接情况.

## 3.优化器

> 重写查询, 决定表的读取顺序, 选择合适的索引.

- 

## 5.常用的存储引擎

> 负责数据的存储和提取. 提供API, 服务器通过API与存储引擎通信.

- `InnoDB`: 具备外键, 支持事务和部分事务回滚(Savepoints), 支持分布式事务(XA)
- `MyISAM`: 占用空间小, 处理速度快, 但不支持事务完整性和并发;
    - 频繁执行全表 count 的场景.
- `Memory`: 存储于内存中, 默认使用哈希索引, 速度快.

## 4.字符编码

> 编码 encode: 将字符映射成一个二进制数据的过程.
>
> 解码 decode: 将一个二进制数据映射到一个字符的过程.

- 使用`show charset`查看支持的字符编码;
- 常用字符编码:
    - `utf8bm4`: 正宗`utf-8`编码,

## 5.数据类型

- 存储数据最小的数据类型通常更好, 但要确保没有低估需要存储的值的范围;
- 简单更好; 简单数据类型通常需要更少的 CPU 周期;
- 尽量避免 NULL, MySQL 难以优化包含 NULL 的列;

- 常用数据类型: `INT, FLOAT, DOUBLE, DATA, TIME, CHAR, VARCHAR, TEXT...`

    - `VARCHAR`: 可变长字符串, 适用于列的最大长度比平均长度大很多, 列的更新很少的数据; 频繁更新会导致碎片化;
    - `CHAR`: 定长, 对于经常变更的数据也不容易产生碎片; 存储空间上比`VARCHAR`更有效率;
    - `BLOB`: 存储的是二进制数据, 没有排序规则或字符集;
    - `TEXT`: 存储的是字符

- 数据库设计需要考虑的点:
    - 使用`tinyint`代替枚举. 枚举的排序效率低, 扩展性不强.
    - 货币类使用`int`或`decimal`, 避免使用`float`和`double`.
    - 时间类型: 更加项目自身需求选择, `varchar, timestamp, datetime`等.
    - 文件类型: 一般 mysql 中仅存储文件名和路径, 文件内存使用`HDFS(Hadoop分布式文件系统)`存储.

## 6.MySQL 帮助文档

- `? xxx;`: 查询`xxx`的命令说明.
    - 例如: `? CREATE DATABASE;`